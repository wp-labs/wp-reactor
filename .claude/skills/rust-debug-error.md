# rust-debug-error

分析 Rust 编译错误或运行时 panic，定位根因并给出修复方案。

## 输入

用户可能提供：
- 编译错误输出（`cargo check` / `cargo build` 的输出）
- 运行时 panic 的 backtrace
- 测试失败的输出
- 或者只是描述"编译不过"/"运行报错"

如果用户没有提供错误输出，主动运行命令获取：

```bash
cargo check --workspace 2>&1
```

## 工作流程

### 第一步：获取完整错误信息

根据错误类型选择合适的命令：

**编译错误：**
```bash
cargo check --workspace 2>&1
```

**测试失败：**
```bash
cargo test --workspace 2>&1
```

**运行时 panic：**
```bash
RUST_BACKTRACE=1 cargo run 2>&1
# 或
RUST_BACKTRACE=1 cargo test <test_name> 2>&1
```

### 第二步：解析错误信息

从错误输出中提取关键信息：
- **错误编号**（如 E0308、E0599）
- **错误位置**（文件:行号:列号）
- **错误类型**（类型不匹配、生命周期、借用检查、trait 未实现等）
- **编译器建议**（help: 行）

### 第三步：阅读相关代码

根据错误位置，读取报错的源文件和相关的上下文代码。重点关注：
- 报错行及其前后 20 行
- 涉及的类型定义
- 涉及的 trait 定义和实现
- 涉及的函数签名

### 第四步：分析根因

按错误类别进行分析：

| 错误类别 | 常见原因 | 排查方向 |
|----------|----------|----------|
| 类型不匹配 E0308 | 函数返回值类型错误、泛型约束不满足 | 检查函数签名和调用处 |
| 借用检查 E0502/E0505 | 可变借用冲突、生命周期不满足 | 分析数据流和借用范围 |
| Trait 未实现 E0599 | 缺少 derive 或手动 impl | 检查类型的 trait bounds |
| 模块/导入 E0433 | use 路径错误、mod 未声明 | 检查模块树和可见性 |
| 生命周期 E0106 | 缺少生命周期标注 | 分析引用关系 |

### 第五步：提供修复方案

给出：
1. **根因说明**：用简洁的语言解释为什么会报错
2. **修复代码**：直接给出修改后的代码
3. **修复验证**：修改后运行编译/测试确认修复

```bash
cargo check -p <affected-crate> 2>&1
```

## 常见模式

### 生命周期问题
- 优先考虑能否用 `.clone()` 或 `.to_owned()` 简化
- 其次考虑调整数据结构（`String` 替代 `&str`）
- 最后才引入显式生命周期标注

### 异步相关问题
- 检查 `.await` 是否遗漏
- 检查 async 函数中是否持有非 Send 类型跨 await 点
- 检查 trait object 是否需要 `Send + Sync` bound

### 宏展开问题
- 使用 `cargo expand` 查看宏展开后的代码（如果安装了 cargo-expand）
- 检查宏输入是否符合预期格式

## 注意事项

- 不要猜测修复方案——先读懂错误信息和相关代码
- 编译器的 `help:` 建议通常很有价值，优先考虑采纳
- 一次修复一个错误，因为后续错误可能是级联的
- 修复后重新运行完整检查，确认没有引入新问题
