# rust-refactor

安全重构 Rust 代码：提取函数、重命名、消除重复、简化结构，确保编译和测试通过。

## 输入

用户可能提供：
- 要重构的文件或模块路径
- 具体的重构意图（如"把这个函数拆小"、"消除重复代码"、"重命名 X 为 Y"）
- 或者只是"这段代码需要整理"

如果用户意图不明确，先阅读代码后提出重构建议，等用户确认再动手。

## 工作流程

### 第一步：理解现有代码

阅读待重构的代码及其调用者：

1. 读取目标文件
2. 搜索所有引用和调用点
3. 检查是否有现有测试覆盖

```bash
# 查找符号的所有引用
grep -rn "<symbol_name>" crates/ --include="*.rs"

# 查看现有测试
cargo test -p <crate> -- --list 2>&1
```

### 第二步：制定重构计划

向用户说明重构方案：
- 要做的具体改动
- 影响的文件范围
- 潜在风险

等用户确认后再执行。

### 第三步：执行重构

按类型执行相应的重构操作：

#### 提取函数
1. 识别可提取的代码块
2. 确定参数（通过分析闭包捕获的变量）
3. 确定返回值
4. 提取为独立函数
5. 替换原来的代码块为函数调用

#### 重命名
1. 找到所有使用该符号的位置（包括文档注释中的引用）
2. 批量替换
3. 特别注意：pub 符号可能被外部 crate 使用

#### 消除重复
1. 识别重复的代码模式
2. 选择合适的抽象方式：
   - 提取公共函数
   - 使用泛型 + trait bound
   - 使用宏（仅当其他方式不合适时）
3. 逐处替换，每替换一处就编译验证

#### 简化结构
1. 减少嵌套层级（early return、guard clause）
2. 用 `?` 替代 match on Result/Option
3. 用迭代器链替代手写循环（仅当可读性不降低时）
4. 消除不必要的 `.clone()`

### 第四步：逐步验证

每完成一个小步骤就验证编译：

```bash
cargo check -p <crate> 2>&1
```

如果重构涉及多个步骤，保持"改一点、编译一次"的节奏，避免大量改动后才发现编译错误。

### 第五步：运行测试

```bash
cargo test -p <crate> 2>&1
```

如果测试失败，分析是重构引入的 bug 还是测试本身需要更新。

### 第六步：全量检查

```bash
cargo clippy --workspace -- -D warnings 2>&1
cargo test --workspace 2>&1
```

确保重构没有影响其他 crate。

## 重构原则

- **行为不变**：重构不改变外部可观察行为
- **小步前进**：每步改动尽量小，频繁编译验证
- **有测试保障**：如果重构区域没有测试，先补测试再重构
- **保持可读性**：重构的目的是让代码更清晰，不是炫技

## 常用重构模式

| 代码味道 | 重构手法 |
|----------|----------|
| 函数过长（>50 行） | 提取子函数 |
| 重复代码块 | 提取公共函数或 trait |
| 深层嵌套 | early return / guard clause |
| 过长的参数列表 | 引入配置 struct |
| match 分支重复 | 提取 match arm 到函数 |
| 大量 `.unwrap()` | 替换为 `?` 或合理的错误处理 |
| 未使用的代码 | 直接删除（不要注释掉） |

## 注意事项

- 对 `pub` 接口的重构要格外谨慎——可能影响下游 crate
- 重命名 pub 符号时搜索整个 workspace
- 不要在重构中偷偷加功能或改行为
- 如果发现需要改的太多，和用户讨论是否分批进行
- 保留 git 历史的可读性：一次 commit 做一件重构事
